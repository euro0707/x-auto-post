# X自動投稿システム

Google Apps Script を使用した X（旧Twitter）の自動投稿・エンゲージメント分析システムです。

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Google Apps Script](https://img.shields.io/badge/Google%20Apps%20Script-Supported-green)](https://developers.google.com/apps-script)

## 📋 目次

- [主な機能](#主な機能)
- [スプレッドシート構成](#スプレッドシート構成)
- [セットアップ](#セットアップ)
- [使い方](#使い方)
- [開発](#開発)
- [トラブルシューティング](#トラブルシューティング)
- [ライセンス](#ライセンス)

## 主な機能

### 📝 投稿管理

- **スケジュール投稿**: スプレッドシートで投稿日時を管理
- **スレッド投稿**: 複数のツイートを連続投稿してスレッド化
- **画像投稿**: 最大4枚の画像を添付可能（セル内貼り付け対応）
- **noteリンク対応**: 投稿後に自動的にリプライとして投稿
- **文字数カウント**: X仕様に準拠した文字数計算（URL短縮対応）
- **二重投稿防止**: LockServiceによる排他制御
- **遅延吸収**: ±5分の許容範囲でトリガー遅延を吸収

### 📊 エンゲージメント分析

- **自動データ取得**: 毎日朝9時に過去30日分のエンゲージメントを自動更新
- **基本指標**: いいね数、リポスト数、返信数、引用数
- **プレミアム指標**: インプレッション数、ブックマーク数（有料プラン専用）
- **人気ツイート分析**: TOP10ランキングと平均エンゲージメント統計

### ⚙️ プラン管理

- **Free（無料）**: 文字数制限140字、基本指標のみ
- **Basic（有料）**: 文字数制限25,000字、全指標取得可能
- **Premium（有料）**: 文字数制限25,000字、全指標取得可能

## スプレッドシート構成

| 列 | 項目 | 説明 |
|---|---|---|
| A | 投稿本文 | ツイート内容 |
| B | 文字数 | 自動計算（X仕様準拠） |
| C | 画像 | 画像を貼り付けまたはURL入力（最大4枚） |
| D | noteリンク | 投稿後にリプライとして投稿される |
| E | 日にち | 投稿予定日（シリアル値） |
| F | 時 | 投稿予定時刻（0〜23） |
| G | 分 | 投稿予定分（0〜59） |
| H | 投稿URL | 投稿完了後のツイートURL |
| I | スレッドグループID | 同じIDでスレッド化 |
| J | ステータス | pending/posting/posted/failed |
| K | いいね数 | エンゲージメント指標（自動更新） |
| L | リポスト数 | エンゲージメント指標（自動更新） |
| M | 返信数 | エンゲージメント指標（自動更新） |
| N | 引用数 | エンゲージメント指標（自動更新） |
| O | インプレッション数 | 有料プラン専用（自動更新） |
| P | ブックマーク数 | 有料プラン専用（自動更新） |
| Q | 最終更新日時 | エンゲージメント更新日時 |

## セットアップ

### 1. リポジトリのクローン

```bash
git clone https://github.com/euro0707/x-auto-post.git
cd x-auto-post
```

### 2. clasp のインストール

```bash
npm install -g @google/clasp
clasp login
```

### 3. X API 認証情報の取得

[X Developer Portal](https://developer.twitter.com/) で以下を取得：

- API Key
- API Secret
- Access Token
- Access Token Secret

### 4. スクリプトプロパティの設定

Apps Script エディタで以下を設定：

**必須:**
```
X_API_KEY: あなたのAPIキー
X_API_SECRET: あなたのAPIシークレット
X_ACCESS_TOKEN: あなたのアクセストークン
X_ACCESS_TOKEN_SECRET: あなたのアクセストークンシークレット
```

**オプション:**
```
xPlanType: free/basic/premium（デフォルト: free）
```

### 5. スプレッドシートの初期設定

メニュー「X自動投稿」から：
1. 【初回のみ】文字数列を挿入
2. 【初回のみ】画像列を挿入
3. 【初回のみ】エンゲージメント列を挿入

### 6. トリガーの設定

#### 自動投稿トリガー

Apps Script エディタ > トリガー > トリガーを追加

- 実行する関数: `postNextScheduledToX`
- イベントのソース: 時間主導型
- 時間ベースのトリガー: 分ベースのタイマー
- 時間の間隔: 10分おき（推奨）

#### エンゲージメント自動更新トリガー

- 実行する関数: `dailyEngagementUpdate`
- イベントのソース: 時間主導型
- 時間ベースのトリガー: 日タイマー
- 時刻: 午前9時〜10時

## 使い方

### 基本的な投稿

1. A列に投稿本文を入力
2. E〜G列に投稿日時を入力（空欄の場合は即時投稿）
3. メニュー「文字数を更新」で文字数を確認
4. トリガーが自動的に投稿を実行

### 画像付き投稿

1. C列に画像を貼り付けるか、Google Drive URLを入力
2. 最大4枚まで対応（カンマ区切りでURL入力可能）
3. 対応形式: JPEG、PNG、GIF

### スレッド投稿

**方法1: メニューを使う（簡単・推奨）**

1. スレッドにしたい複数行を選択
2. メニュー「選択行を1つのスレッドにまとめる」を実行
3. 自動的に同じグループIDが設定される
4. 最初の行の日時に自動投稿される

**方法2: 手動設定**

1. I列に同じIDを入力（例: `thread001`）
2. 同じIDを持つ行が連続投稿される

### エンゲージメント確認

**手動更新:**
- メニュー「エンゲージメントを更新」を実行
- K〜Q列に指標が記録される

**自動更新:**
- トリガー設定で毎日朝9時に自動実行
- 過去30日分が対象

**人気ツイート分析:**
- メニュー「人気ツイートTOP10を表示」を実行
- エンゲージメント合計でランキング表示

### Xプラン設定

1. メニュー「⚙️ Xプラン設定」を開く
2. free/basic/premiumを選択
3. 文字数制限とエンゲージメント指標が自動切替

## 開発

### ローカル開発

```bash
# コードをプル
clasp pull

# 編集後プッシュ
clasp push

# ブラウザで開く
clasp open
```

### プロジェクト構成

```
x-auto-post/
├── src/
│   ├── post_x.js          # メインスクリプト（2,038行）
│   └── appsscript.json    # Apps Script設定
├── .clasp.json            # clasp設定
├── .gitignore             # Git除外設定
└── README.md              # このファイル
```

### 技術仕様

- **認証**: OAuth 1.0a
- **API**: X API v2（ツイート投稿・取得）、v1.1（メディアアップロード）
- **レート制限**: 900リクエスト/15分（無料プラン）
- **文字数制限**: プランに応じて自動切替
- **画像形式**: JPEG、PNG、GIF対応（最大4枚）

### 主要関数

#### 投稿関連
- `postNextScheduledToX()` - 次の投稿を実行
- `postSingleTweet_()` - 単一ツイート投稿
- `postSingleRow_()` - 1行を投稿
- `postThreadGroup_()` - スレッド投稿

#### エンゲージメント関連
- `updateAllEngagementMetrics()` - 手動更新
- `dailyEngagementUpdate()` - 自動更新（トリガー用）
- `getTweetEngagement_()` - API取得
- `analyzeTopTweets()` - TOP10分析

#### 便利機能
- `updateCharacterCounts()` - 文字数一括更新
- `checkAllCharacterCounts()` - 超過チェック
- `groupSelectedRowsAsThread()` - スレッドグループ化

## トラブルシューティング

### 投稿が実行されない

- スクリプトプロパティが正しく設定されているか確認
- トリガーが有効になっているか確認
- ログを確認（表示 > ログ）
- ステータスが`pending`になっているか確認

### エンゲージメントが取得できない

- 投稿URLが正しく記録されているか確認（H列）
- X API のレート制限に達していないか確認
- Xプラン設定が正しいか確認（メニュー > ⚙️ Xプラン設定）
- ステータスが`posted`になっているか確認

### 文字数が合わない

- URLは23文字として計算される
- 絵文字は1文字としてカウント
- 改行も1文字としてカウント
- メニュー「文字数を更新」で再計算

### スレッド投稿がうまくいかない

- I列に同じIDが入力されているか確認
- 最初の行にのみ日時を入力しているか確認
- ステータスが`posted`や`posting`になっていないか確認
- メニュー機能を使うと簡単

### 画像が投稿されない

- C列に画像が貼り付けられているか確認
- 画像形式がJPEG/PNG/GIFか確認
- 最大4枚までの制限を超えていないか確認
- Google Drive URLの場合、共有設定を確認

## 🔒 セキュリティ

**重要**: API認証情報は絶対にGitHubにコミットしないでください。

- ✅ `.gitignore` が設定されている
- ✅ API認証情報はスクリプトプロパティに設定
- ✅ スプレッドシートの共有設定が制限付き
- ✅ 定期的にトークンをローテーション

## 🤝 コントリビューション

バグ報告や機能提案は Issue でお願いします。プルリクエストも歓迎します。

## 📝 ライセンス

MIT License

## 🔗 関連リンク

- [X Developer Portal](https://developer.twitter.com/)
- [Google Apps Script ドキュメント](https://developers.google.com/apps-script)
- [X API v2 ドキュメント](https://developer.twitter.com/en/docs/twitter-api)

---

**作成者**: [@euro0707](https://github.com/euro0707)

🤖 Generated with [Claude Code](https://claude.com/claude-code)
