# X（旧Twitter）自動投稿GASシステム

スプレッドシートから予定投稿を管理し、指定した日時にXへ自動投稿するGoogle Apps Scriptシステムです。

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Google Apps Script](https://img.shields.io/badge/Google%20Apps%20Script-Supported-green)](https://developers.google.com/apps-script)

## 📋 目次

- [主な機能](#主な機能)
- [セットアップ](#セットアップ)
- [使用方法](#使用方法)
- [セキュリティ](#セキュリティ)
- [トラブルシューティング](#トラブルシューティング)
- [ライセンス](#ライセンス)

## 主な機能

- スプレッドシートでの投稿管理
- 日時指定による予約投稿
- 投稿済みフラグとURL記録
- **二重投稿防止（LockService）**
  - トリガー重複実行時の二重投稿を防止
- **遅延吸収（±5分の許容窓）**
  - トリガーのタイミングずれを吸収
  - 1日1回実行でも安心
- **noteリプライ機能**
  - B列にnoteのURLを入力すると、投稿後に自動的にリプライとして投稿
  - 単独投稿でもスレッド投稿でも対応
  - メイン投稿が失敗してもnoteリプライは影響しない
- **ステータス管理（H列）**
  - pending: 投稿待ち
  - posting: 投稿中
  - posted: 投稿完了
  - failed: 投稿失敗
- **スレッド投稿機能（連続投稿）**
  - 同じスレッドグループIDを持つ行を自動的に連続投稿
  - 無料アカウントでも長文を複数投稿に分割可能
  - **スレッドID自動設定メニュー**で簡単にスレッド設定が可能
- **文字数制限チェック（無料: 140文字 / プレミアム: 25,000文字）**
- **X仕様準拠の文字数カウント**
  - 改行も1文字としてカウント
  - 絵文字も1文字としてカウント
  - URLは自動短縮され、1リンクあたり約23文字でカウント
- 投稿前プレビュー
- 一括文字数チェック機能

## セットアップ

### 1. スプレッドシートの準備

以下の列構成でシートを作成してください（シート名: `sheet`）：

| 列 | 項目 | 説明 |
|---|---|---|
| A列 | 投稿本文 | ツイート本文（文字数制限に注意） |
| B列 | noteリンク | note記事のURL（任意、投稿後にリプライとして投稿） |
| C列 | 日にち | 日付（yyyy/mm/dd形式またはシリアル値） |
| D列 | 時 | 時刻（0〜23、空欄は0時） |
| E列 | 分 | 分（0〜59、空欄は0分） |
| F列 | 投稿URL | 投稿後のツイートURLまたはエラー情報 |
| G列 | スレッドグループID | スレッド投稿用のグループID（空欄は単独投稿） |
| H列 | ステータス | 投稿状態（pending/posting/posted/failed） |

### 2. スクリプトプロパティの設定

GASエディタで以下のスクリプトプロパティを設定してください：

- `X_API_KEY` - X APIのConsumer Key
- `X_API_SECRET` - X APIのConsumer Secret
- `X_ACCESS_TOKEN` - アクセストークン（ユーザーコンテキスト）
- `X_ACCESS_TOKEN_SECRET` - アクセストークンシークレット

**注意**: 投稿権限を持つユーザーコンテキストのトークンが必要です。

### 3. トリガーの設定

定期実行したい場合は、GASエディタのトリガー設定で以下を追加：

- 実行する関数: `postNextScheduledToX`
- イベントソース: 時間主導型
- 時間ベースのトリガー: 例）1分ごと、5分ごと、など

## 文字数制限設定

Code.gsの`CONFIG`オブジェクトで文字数制限を設定できます：

```javascript
characterLimit: Object.freeze({
  enabled: true,         // 文字数チェックを有効にする場合は true
  plan: 'free',          // 'free' (140文字) または 'premium' (25,000文字)
  skipOnExceed: true,    // 超過時にスキップする場合は true、エラーにする場合は false
  urlLength: 23          // URLは自動短縮され、1リンクあたり約23文字としてカウント
})
```

### プラン別の設定

#### 無料アカウント（140文字制限）
```javascript
enabled: true,
plan: 'free',
skipOnExceed: true
```

#### Xプレミアム（25,000文字制限）
```javascript
enabled: true,
plan: 'premium',
skipOnExceed: true
```

#### チェック無効化
```javascript
enabled: false,
plan: 'free',
skipOnExceed: true
```

### 文字数カウント方式

X（旧Twitter）の公式仕様に準拠：

- **改行**: 1文字としてカウント（半角扱い）
- **絵文字**: 1文字としてカウント（例: 😀 = 1文字）
- **URL**: 自動短縮され、1リンクあたり約23文字でカウント
  - 例: `https://example.com/very/long/url` = 23文字
- **画像・動画**: 文字数に影響しない（このスクリプトでは未対応）

### 超過時の動作

- `skipOnExceed: true` - 文字数超過の行をスキップして次の行を探す（F列にエラー記録）
- `skipOnExceed: false` - エラーを発生させて処理を停止

## 使用方法

### 基本的な投稿フロー

#### 単独投稿（通常の投稿）

1. A列に投稿本文を入力
2. **B列にnoteのURL**を入力（任意、リプライとして投稿される）
3. C列に投稿日、D列に時、E列に分を入力
4. G列は空欄のまま（単独投稿）
5. トリガーまたは手動で`postNextScheduledToX()`を実行
6. 投稿成功時：F列にツイートURL、H列に`posted`
7. noteURLがある場合、メイン投稿の直後にリプライとして自動投稿される

#### スレッド投稿（連続投稿）

**方法1: スレッド機能メニューを使う（簡単・推奨）**

1. A列に各投稿の本文を入力（複数行）
2. **B列にnoteのURL**を入力（任意、スレッドの最後にリプライとして投稿）
3. C〜E列に最初の行の投稿日時を入力（他の行は空欄でOK）
4. **スレッドにしたい行を範囲選択**（2行以上）
5. **メニューバー「スレッド機能」→「選択行を1つのスレッドにまとめる」**
6. 自動的にG列に同じスレッドグループIDが設定される
7. トリガーまたは手動で`postNextScheduledToX()`を実行

**方法2: 手動でスレッドグループIDを入力**

1. A列に各投稿の本文を入力（複数行）
2. **B列にnoteのURL**を入力（任意、スレッドの最後にリプライとして投稿）
3. C〜E列に最初の行の投稿日時を入力（他の行は空欄でOK）
4. **G列に同じスレッドグループID**を入力（例: `thread001`）
5. トリガーまたは手動で`postNextScheduledToX()`を実行
6. 同じIDを持つすべての行が連続投稿される
7. 各行のF列に投稿URLが記録される

**スレッド投稿の例:**

| A列（本文） | B列（noteURL） | C列 | D列 | E列 | F列 | G列 | H列 |
|------------|-------------|-----|-----|-----|-----|-----|-----|
| これは1つ目の投稿です。 | https://note.com/article | 2025/01/15 | 10 | 0 | | thread-20250130-001 | pending |
| これは2つ目の投稿です。 | | | | | | thread-20250130-001 | pending |
| これは3つ目の投稿です。 | | | | | | thread-20250130-001 | pending |

→ 実行すると、3つの投稿が連続してスレッド形式で投稿され、最後にnoteURLがリプライとして投稿されます。

### 便利な関数

#### 次回投稿予定の確認
```javascript
previewNextScheduledRow()
```
次に投稿される行の情報を表示（投稿は実行しない）

#### 全行の文字数チェック
```javascript
checkAllCharacterCounts()
```
すべての行の文字数を確認し、超過している行を一覧表示（URLは23文字換算、絵文字も正確にカウント）

実行例：
```
=== 文字数チェック結果 ===
プラン: free
制限: 140文字
総行数: 50行
OK: 48行
NG: 2行
※URLは23文字換算、絵文字も1文字としてカウント

--- 文字数超過の行 ---
行5: 156文字（16文字超過） "今日は素晴らしい天気ですね。..."
行12: 145文字（5文字超過） "お知らせです。新機能をリリー..."
```

## スレッド投稿の詳細

### スレッド機能メニューの使い方

スプレッドシートを開くと、メニューバーに「スレッド機能」が追加されます。

#### 選択行を1つのスレッドにまとめる

1. スレッドにしたい行を範囲選択（2行以上）
2. メニューバー「スレッド機能」→「選択行を1つのスレッドにまとめる」
3. 自動的に`thread-YYYYMMDD-XXX`形式のIDが生成・設定される（連番: 001, 002, 003...）
4. 確認ダイアログが表示される

#### スレッドIDをクリア

1. クリアしたい行を範囲選択
2. メニューバー「スレッド機能」→「スレッドIDをクリア」
3. 選択範囲のF列がクリアされる

### スレッドグループIDについて

- F列に任意の文字列を入力（例: `thread001`, `お知らせ_2025-01`, `長文投稿_A`など）
- 同じIDを持つ行がすべて連続投稿される
- IDが空欄の場合は単独投稿として扱われる
- **自動生成されるID形式**: `thread-20250130-001`（日付+3桁連番）
  - 同じ日に複数スレッド作成すると自動で002, 003...と採番される

### スレッド投稿の動作

1. 最初の行の日時でスケジュール判定
2. 時刻が来たら、同じIDを持つすべての未投稿行を取得
3. 上から順番に連続投稿（リプライチェーン形式）
4. 各投稿の間に1秒の待機時間（API制限対策）
5. すべての投稿が完了したら、各行のE列とG列を更新

### スレッド投稿の利点

- **無料アカウントでも長文を分割投稿可能**
- 各投稿が140文字以内なら、何件でも連続投稿できる
- 読みやすい形式で長文を伝えられる
- プレミアムに課金しなくても長文投稿が実現できる

### スレッド投稿の注意点

- スレッド内の1つの投稿でも文字数超過すると、その投稿はスキップされる
- API制限により、あまりに多い投稿（数十件以上）を一度に行うと制限に引っかかる可能性がある
- 投稿途中でエラーが発生した場合、それ以降の投稿は実行されない

## 実行制御の詳細

### 二重投稿防止（LockService）

トリガーが重複実行された場合でも、LockServiceで排他制御を行い、二重投稿を防ぎます。

```
実行1: ロック取得 → 投稿処理 → ロック解放
実行2: ロック取得失敗 → スキップ
```

ログに「別のプロセスが実行中のため、この実行をスキップします」と表示されます。

### 遅延吸収（±5分の許容窓）

トリガーが正確に動作しない場合でも、予定時刻の前後5分以内なら投稿されます。

**設定変更方法:**
```javascript
// Code.gs の CONFIG.execution.toleranceMinutes を変更
toleranceMinutes: 5,  // 5分 → 10分に変更する場合は 10
```

**例:**
```
投稿予定: 10:00
実行時刻: 10:02（2分遅れ）
→ 10:00±5分の範囲内なので投稿される
```

### ステータス管理（G列）

各行の投稿状態をG列で管理します：

- **pending**: 投稿待ち（初期状態）
- **posting**: 投稿処理中
- **posted**: 投稿完了
- **failed**: 投稿失敗（E列にエラー詳細）

**注意**: `posting`のままになっている場合は、前回の実行が途中で終了した可能性があります。手動で`pending`に戻してください。

## トラブルシューティング

### 文字数超過で投稿されない

1. `checkAllCharacterCounts()`を実行して超過行を確認
2. A列の本文を制限内に編集
   - 無料版: 140文字以内
   - プレミアム: 25,000文字以内
3. または`CONFIG.characterLimit.plan`を変更
   - 無料からプレミアムへ: `plan: 'free'` → `plan: 'premium'`
4. URLは23文字でカウントされることに注意
   - 例: 長いURLを使っても実質23文字分
5. **スレッド機能を使う（無料版推奨）**
   - 長文を140文字ごとに分割して複数行に分ける
   - メニューバー「スレッド機能」→「選択行を1つのスレッドにまとめる」で簡単設定
   - または手動でF列に同じIDを入力してスレッド投稿

### 投稿がスキップされる

- E列に「文字数超過」と記録されている場合は本文を短縮
- C・D列が空欄の場合は投稿されないので日時を入力
- G列が`posted`になっている場合は既に投稿済み

### スレッド投稿がうまくいかない

- F列に同じIDが入力されているか確認
- 最初の行にのみB〜D列（日時）を入力しているか確認
- G列が`posted`や`posting`になっていないか確認
- **スレッド機能メニュー**を使って設定すると簡単

### ステータスが`posting`のままになっている

前回の実行が途中で終了した可能性があります：
1. G列を`pending`に戻す
2. 再度実行

### 二重投稿が発生する

通常はLockServiceで防止されますが、以下を確認：
1. トリガーの実行間隔が短すぎないか（最低1分以上推奨）
2. G列が正しく機能しているか
3. 複数のトリガーが設定されていないか

### エラーが発生する

- スクリプトプロパティが正しく設定されているか確認
- X APIのトークンがユーザーコンテキストか確認
- シート名が`sheet`になっているか確認
- G列が追加されているか確認

## 📁 ファイル構成

```
GAS/
├── Code.gs                 # メインスクリプト
├── README.md              # 使い方ドキュメント
├── SECURITY.md            # セキュリティガイド
├── .gitignore             # Git除外設定
├── .env.example           # 環境変数サンプル
└── LICENSE                # ライセンス
```

## 🔒 セキュリティ

**重要**: API認証情報は絶対にGitHubにコミットしないでください。

詳細は [SECURITY.md](SECURITY.md) を参照してください。

### クイックチェックリスト

- ✅ `.gitignore` が設定されている
- ✅ `.env` ファイルは `.gitignore` に含まれている
- ✅ API認証情報はスクリプトプロパティに設定
- ✅ スプレッドシートの共有設定が制限付き
- ✅ 定期的にトークンをローテーション

## 🤝 コントリビューション

バグ報告や機能提案は Issue でお願いします。プルリクエストも歓迎します。

## 📝 ライセンス

MIT License - 詳細は [LICENSE](LICENSE) を参照してください。

自由に改変・利用してください。

## 🔗 関連リンク

- [X Developer Portal](https://developer.twitter.com/)
- [Google Apps Script ドキュメント](https://developers.google.com/apps-script)
- [X API v2 ドキュメント](https://developer.twitter.com/en/docs/twitter-api)

---

**作成者**: GitHub @skyeu
**最終更新**: 2025年1月
