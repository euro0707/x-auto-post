# テスト運用ガイド

X自動投稿GASシステムのテスト手順を説明します。

## 📋 事前準備チェックリスト

### 1. スプレッドシートの準備

- [ ] Googleスプレッドシートを開いている
- [ ] シート名が「sheet」になっている
- [ ] 以下の列が設定されている：

| A | B | C | D | E | F | G | H |
|---|---|---|---|---|---|---|---|
| 投稿本文 | 日にち | 時 | 分 | ☑投稿済み | 投稿URL | スレッドID | ステータス |

### 2. スクリプトの準備

- [ ] 「拡張機能」→「Apps Script」を開いている
- [ ] Code.gsに新しいスクリプトをコピー済み
- [ ] 保存済み（Ctrl+S）

### 3. API認証情報の準備

- [ ] X_API_KEY を持っている
- [ ] X_API_SECRET を持っている
- [ ] X_ACCESS_TOKEN を持っている
- [ ] X_ACCESS_TOKEN_SECRET を持っている

## 🚀 ステップ1: スクリプトプロパティの設定

1. GASエディタで「プロジェクトの設定」（⚙️アイコン）をクリック
2. 「スクリプト プロパティ」セクションで「プロパティを追加」
3. 以下の4つを追加：

| プロパティ | 値 |
|-----------|-----|
| X_API_KEY | あなたのAPIキー |
| X_API_SECRET | あなたのAPIシークレット |
| X_ACCESS_TOKEN | あなたのアクセストークン |
| X_ACCESS_TOKEN_SECRET | あなたのアクセストークンシークレット |

4. 「スクリプト プロパティを保存」をクリック

## 🧪 ステップ2: テストデータの作成

### テスト1: 単独投稿（即時実行）

スプレッドシートに以下を入力：

| A列 | B列 | C列 | D列 | E列 | F列 | G列 | H列 |
|-----|-----|-----|-----|-----|-----|-----|-----|
| テスト投稿です。問題なく動作していることを確認しています。 | 2025/01/30 | 14 | 0 | | | | |

**注意**: C列（時）には**現在時刻より1〜2時間前**の値を入力してください。
- 例: 現在が15時なら、13か14を入力

### テスト2: スレッド投稿

| A列 | B列 | C列 | D列 | E列 | F列 | G列 | H列 |
|-----|-----|-----|-----|-----|-----|-----|-----|
| スレッドテスト1つ目：これは最初の投稿です。 | 2025/01/30 | 14 | 0 | | | test001 | |
| スレッドテスト2つ目：これは2番目の投稿です。 | | | | | | test001 | |
| スレッドテスト3つ目：これは3番目の投稿です。 | | | | | | test001 | |

### テスト3: 文字数超過テスト

| A列 | B列 | C列 | D列 | E列 | F列 | G列 | H列 |
|-----|-----|-----|-----|-----|-----|-----|-----|
| これは140文字を超えるテストです。これは140文字を超えるテストです。これは140文字を超えるテストです。これは140文字を超えるテストです。これは140文字を超えるテストです。これは140文字を超えるテストです。 | 2025/01/30 | 14 | 0 | | | | |

## ▶️ ステップ3: 手動実行テスト

### 実行方法

1. GASエディタに戻る
2. 関数選択ドロップダウンから「postNextScheduledToX」を選択
3. 「実行」ボタン（▶️）をクリック

### 初回実行時の承認

初回実行時は権限の承認が必要です：

1. 「承認が必要です」と表示される
2. 「権限を確認」をクリック
3. Googleアカウントを選択
4. 「詳細」→「（安全ではないページ）に移動」をクリック
5. 「許可」をクリック

### 実行ログの確認

1. GASエディタの下部に「実行ログ」が表示される
2. 以下のようなログが表示されることを確認：

```
ロックを取得しました。投稿処理を開始します。
行 2 の文字数チェック OK（XX/140文字、プラン: free）
行 2 を投稿しました: https://x.com/i/web/status/...
ロックを解放しました。
```

### スプレッドシートの確認

投稿が成功した場合：
- **E列**: チェックが入る
- **F列**: ツイートURLが記録される
- **H列**: `posted` が表示される

投稿が失敗した場合：
- **F列**: エラーメッセージが表示される
- **H列**: `failed` が表示される

## ✅ ステップ4: X（旧Twitter）で確認

1. Xのアカウントにログイン
2. 自分のプロフィールを開く
3. 投稿が表示されているか確認

**スレッド投稿の場合**:
- 3つの投稿が連続して表示される
- 2つ目と3つ目に「返信先」マークがある

## 🔧 ステップ5: トリガーの設定（自動実行）

手動実行が成功したら、自動実行の設定をします。

### トリガーの追加

1. GASエディタで「トリガー」アイコン（⏰）をクリック
2. 「トリガーを追加」をクリック
3. 以下のように設定：

| 項目 | 設定値 |
|------|--------|
| 実行する関数 | postNextScheduledToX |
| イベントソース | 時間主導型 |
| 時間ベースのトリガー | **1日1回**（推奨） |
| 時刻 | 例: 午前9時〜10時 |

4. 「保存」をクリック

### おすすめの設定

**1日1回投稿の場合:**
```
実行する関数: postNextScheduledToX
時間ベースのトリガー: 日付ベースのタイマー
時刻: 午前9時〜10時
```

**1時間ごとにチェックしたい場合:**
```
実行する関数: postNextScheduledToX
時間ベースのトリガー: 時間ベースのタイマー
時間の間隔: 1時間おき
```

## 🐛 トラブルシューティング

### エラー: 「投稿対象の行が見つかりませんでした」

**原因**: 投稿時刻が未来または古すぎる

**解決策**:
- C列（時）を現在時刻より1〜2時間前に設定
- または、B列を今日の日付に変更

### エラー: 「X API エラー 403」

**原因**: API認証情報が間違っている、またはアクセストークンがユーザーコンテキストではない

**解決策**:
1. スクリプトプロパティを再確認
2. X Developer Portalでトークンを再生成
3. ユーザーコンテキストのトークンであることを確認

### エラー: 「スクリプトプロパティ X_API_KEY を設定してください」

**原因**: スクリプトプロパティが設定されていない

**解決策**:
- ステップ1を再度実行
- プロパティ名が正確か確認（大文字小文字も含む）

### 投稿が実行されない

**確認ポイント**:
1. H列のステータスを確認
   - `posting`のまま → 手動で`pending`に変更
   - `posted` → 既に投稿済み
   - `failed` → F列のエラーを確認
2. E列にチェックが入っていないか確認
3. 投稿時刻が±5分の範囲内か確認

### ステータスが`posting`のまま

**原因**: 前回の実行が途中で終了した

**解決策**:
1. H列を`pending`に変更
2. E列のチェックを外す
3. 再度実行

## 📊 テスト結果の記録

テストが成功したら、以下を記録しておきましょう：

- [ ] 単独投稿: 成功 / 失敗
- [ ] スレッド投稿: 成功 / 失敗
- [ ] 文字数超過: 正しくスキップされた
- [ ] ステータス管理: 正しく動作
- [ ] トリガー設定: 完了

## 🎉 次のステップ

テストが成功したら：

1. 実際の投稿スケジュールを入力
2. トリガーを1日1回に設定
3. 定期的にスプレッドシートを確認
4. 必要に応じて投稿内容を追加

---

**問題が発生した場合**: エラーメッセージとログを確認して、上記のトラブルシューティングを参照してください。
